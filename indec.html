<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Gastos</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <!-- Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- PALETA --- */
    :root {
      --fondo: #e6d5ce;
      --panel: #f2e7e3;
      --rosado: #c38b7b;
      --marron: #6b564f;
      --texto: #4b403c;
    }

    body {
      font-family: "Arial", sans-serif;
      padding: 20px;
      background: var(--fondo);
      color: var(--texto);
      margin: auto;
      max-width: 500px;
    }

    h2, h3 {
      text-align: center;
      color: var(--marron);
      font-weight: 700;
    }

    .card {
      background: var(--panel);
      padding: 15px;
      border-radius: 20px;
      margin-bottom: 15px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    input, select {
      width: 100%;
      padding: 12px;
      border: 1px solid #bfaeaa;
      border-radius: 15px;
      margin-bottom: 10px;
      background: #fff;
    }

    button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border: none;
      border-radius: 20px;
      background: var(--rosado);
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    button:hover {
      background: #a66c5e;
    }

    /* Lista de Gastos */
    .item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    }

    .item-info small {
      color: #6d5b55;
    }

    /* Bot√≥n eliminar */
    .btn-delete {
      background: none;
      border: none;
      cursor: pointer;
      padding: 6px;
      border-radius: 50%;
      width: 34px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-delete img {
      width: 20px;
      opacity: 0.8;
    }

    .btn-delete:hover img {
      opacity: 1;
    }

    /* Total */
    .total-box {
      background: #dcd1cc;
      padding: 15px;
      border-radius: 15px;
      text-align: center;
      font-weight: bold;
      margin-top: 15px;
    }
  </style>
</head>

<body>

  <h2>Registro de Gastos</h2>

  <!-- FORMULARIO -->
  <div class="card">
    <label>Descripci√≥n:</label>
    <input id="descripcion" type="text" />

    <label>Cuotas:</label>
    <input id="cuotas" type="number" />

    <label>Costo:</label>
    <input id="costo" type="number" />

    <label>Categor√≠a:</label>
    <select id="categoria">
      <option>Casa</option>
      <option>Comida</option>
      <option>Salidas</option>
      <option>Importaciones</option>
      <option>Apps</option>
      <option>Entretenimiento</option>
    </select>

    <button onclick="agregarGasto()">Agregar</button>
  </div>

  <!-- FILTROS -->
  <h3>Filtros</h3>
  <div class="card">
    <label>Filtrar por categor√≠a:</label>
    <select id="filtroCategoria" onchange="cargarGastos()">
      <option value="todos">Todos</option>
      <option>Casa</option>
      <option>Comida</option>
      <option>Salidas</option>
      <option>Importaciones</option>
      <option>Apps</option>
      <option>Entretenimiento</option>
    </select>
  </div>

  <!-- GASTOS -->
  <h3>Gastos Guardados</h3>
  <div id="lista"></div>

  <div class="total-box" id="totalBox">Total: S/ 0</div>

  <!-- EXPORTAR -->
  <button onclick="exportarExcel()" style="background:#7d9c63">Exportar a Excel</button>

  <!-- Firebase + Funciones -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB3xqw4u56I5oS1cBXMm5OSZrE7QdN7g2Y",
      authDomain: "gastospareja-c29c2.firebaseapp.com",
      projectId: "gastospareja-c29c2",
      storageBucket: "gastospareja-c29c2.firebasestorage.app",
      messagingSenderId: "409737003820",
      appId: "1:409737003820:web:972ec80df04f44a230e289"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* AGREGAR GASTO */
    async function agregarGasto() {
      const descripcion = document.getElementById("descripcion").value;
      const cuotas = document.getElementById("cuotas").value;
      const costo = Number(document.getElementById("costo").value);
      const categoria = document.getElementById("categoria").value;

      if (!descripcion || !cuotas || !costo) {
        alert("Completa todos los campos");
        return;
      }

      await db.collection("gastos").add({
        descripcion,
        cuotas: Number(cuotas),
        costo,
        categoria,
        fecha: new Date().toLocaleString("es-PE")
      });

      document.getElementById("descripcion").value = "";
      document.getElementById("cuotas").value = "";
      document.getElementById("costo").value = "";

      cargarGastos();
    }

    /* ELIMINAR */
    async function eliminarGasto(id) {
      await db.collection("gastos").doc(id).delete();
      cargarGastos();
    }

    /* CARGAR LISTA */
    async function cargarGastos() {
      const lista = document.getElementById("lista");
      lista.innerHTML = "";

      const filtro = document.getElementById("filtroCategoria").value;
      let query = db.collection("gastos");

      if (filtro !== "todos") {
        query = query.where("categoria", "==", filtro);
      }

      const snapshot = await query.get();
      let total = 0;

      snapshot.forEach(doc => {
        const d = doc.data();
        total += d.costo;

        lista.innerHTML += `
          <div class="item">
            <div class="item-info">
              <strong>${d.descripcion}</strong><br>
              <small>${d.categoria} ‚Ä¢ Cuotas: ${d.cuotas}</small><br>
              <small>üìÖ ${d.fecha}</small><br>
              <strong>S/ ${d.costo}</strong>
            </div>
            <button class="btn-delete" onclick="eliminarGasto('${doc.id}')">
              <img src="https://cdn-icons-png.flaticon.com/512/3096/3096673.png">
            </button>
          </div>
        `;
      });

      document.getElementById("totalBox").innerText = "Total: S/ " + total;
    }

    cargarGastos();

    /* EXPORTAR */
    async function exportarExcel() {
      const snapshot = await db.collection("gastos").get();
      const datos = [];
      let total = 0;

      snapshot.forEach(doc => {
        const d = doc.data();
        datos.push({
          Descripci√≥n: d.descripcion,
          Categor√≠a: d.categoria,
          Cuotas: d.cuotas,
          Costo: d.costo,
          Fecha: d.fecha
        });
        total += d.costo;
      });

      datos.push({
        Descripci√≥n: "TOTAL",
        Categor√≠a: "-",
        Cuotas: "-",
        Costo: total,
        Fecha: "-"
      });

      const hoja = XLSX.utils.json_to_sheet(datos);
      const libro = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(libro, hoja, "Gastos");
      XLSX.writeFile(libro, "gastos.xlsx");
    }
  </script>

</body>
</html>
